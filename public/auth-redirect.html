<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>DraftWolf Authentication</title>
    <link rel="icon" href="icon.png" />

    <style>
        body {
            background: #111;
            color: #eee;
            font-family: system-ui, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }

        .spinner {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, .2);
            border-top-color: #4da3ff;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        #status {
            font-size: 1.2rem;
        }

        #logs {
            margin-top: 20px;
            font-family: monospace;
            font-size: .85rem;
            color: #999;
            max-width: 90%;
            word-break: break-word;
        }
    </style>
</head>

<body>
    <div class="spinner"></div>
    <div id="status">Initializingâ€¦</div>
    <div id="logs"></div>

    <script type="module">
        import { initializeApp } from
            "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getAuth,
            GoogleAuthProvider,
            signInWithRedirect,
            getRedirectResult,
            setPersistence,
            browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Firebase config - values injected at build time
        const firebaseConfig = {
            apiKey: "AIzaSyD3BhG--fI6c8V3TSa5l-2uOBlvBZFt1SQ",
            authDomain: "draftflow-905d4.firebaseapp.com",
            projectId: "draftflow-905d4",
            appId: "1:233410681710:web:33f6a0a6f39ba70c8dbf7f",
        };

        const status = msg =>
            document.getElementById("status").innerText = msg;

        const log = msg => {
            console.log(msg);
            document.getElementById("logs").innerHTML += `<div>${msg}</div>`;
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({
            prompt: 'select_account'
        });

        try {
            // ðŸ”’ Required for redirect auth stability
            await setPersistence(auth, browserLocalPersistence);

            status("Checking sign-in resultâ€¦");

            // 1ï¸âƒ£ Check for Redirect Result (Google Credential)
            const result = await getRedirectResult(auth);

            if (result) {
                // âœ… FIXED: Get the Google ID Token (from IdP), NOT the Firebase ID Token
                // The Electron app needs this Google Token to call signInWithCredential/GoogleAuthProvider
                const credential = GoogleAuthProvider.credentialFromResult(result);
                const googleToken = credential?.idToken;

                if (googleToken) {
                    status("Sign-in successful");
                    log(`Logged in as ${result.user.displayName}`);
                    log("You may now close this tab.");

                    globalThis.location.href =
                        `myapp://auth?token=${encodeURIComponent(googleToken)}`;
                } else {
                    throw new Error("Google Sign-In succeeded, but no ID Token was returned. Check scopes.");
                }
            } else {
                // 2ï¸âƒ£ First visit â†’ immediately start Google login
                const params = new URLSearchParams(globalThis.location.search);
                if (params.get("mode") === "google") {
                    status("Redirecting to Googleâ€¦");
                    // Force a new login to ensure we get a fresh Google Credential
                    await signInWithRedirect(auth, provider);
                } else {
                    // 3ï¸âƒ£ Fallback: weird state (logged in but no credential?).
                    // We cannot proceed because we need the Google Token which is not persisted in session.
                    status("No credentials found. Please restart login.");
                    log("Error: Session exists but Google Credential is lost. Redirecting to login...");

                    // Optional: Auto-retry logic
                    setTimeout(() => {
                        const cleanUrl = new URL(globalThis.location.href);
                        cleanUrl.searchParams.set("mode", "google");
                        globalThis.location.href = cleanUrl.toString();
                    }, 2000);
                }
            }

        } catch (err) {
            status("Authentication error");
            log(err.message);
            console.error(err);
        }
    </script>
</body>

</html>