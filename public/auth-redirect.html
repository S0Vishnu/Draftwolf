<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>DraftFlow Authentication</title>
    <link rel="icon" href="icon.png" />

    <style>
        body {
            background: #111;
            color: #eee;
            font-family: system-ui, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }

        .spinner {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, .2);
            border-top-color: #4da3ff;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        #status {
            font-size: 1.2rem;
        }

        #logs {
            margin-top: 20px;
            font-family: monospace;
            font-size: .85rem;
            color: #999;
            max-width: 90%;
            word-break: break-word;
        }
    </style>
</head>

<body>
    <div class="spinner"></div>
    <div id="status">Initializingâ€¦</div>
    <div id="logs"></div>

    <script type="module">
        import { initializeApp } from
            "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
            getAuth,
            GoogleAuthProvider,
            signInWithRedirect,
            getRedirectResult,
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        (async () => {
            const firebaseConfig = {
                apiKey: "AIzaSyD3BhG--fI6c8V3TSa5l-2uOBlvBZFt1SQ",
                authDomain: "draftflow-905d4.firebaseapp.com",
                projectId: "draftflow-905d4",
                appId: "1:233410681710:web:33f6a0a6f39ba70c8dbf7f",
            };

            const status = msg =>
                document.getElementById("status").innerText = msg;

            const log = msg => {
                console.log(msg);
                document.getElementById("logs").innerHTML += `<div>${msg}</div>`;
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const provider = new GoogleAuthProvider();

            try {
                // ðŸ”’ Required for redirect auth stability
                await setPersistence(auth, browserLocalPersistence);

                status("Checking sign-in resultâ€¦");

                // 1ï¸âƒ£ If we just returned from Google, this will exist
                const result = await getRedirectResult(auth);

                if (result?.user) {
                    status("Sign-in successful");
                    log(`User: ${result.user.email}`);

                    const token = await result.user.getIdToken();
                    log("Token acquired, redirecting to appâ€¦");

                    window.location.href =
                        `myapp://auth?token=${encodeURIComponent(token)}`;
                    return;
                }

                // 2ï¸âƒ£ First visit â†’ immediately start Google login
                const params = new URLSearchParams(window.location.search);
                if (params.get("mode") === "google") {
                    status("Redirecting to Googleâ€¦");
                    await signInWithRedirect(auth, provider);
                    return;
                }

                // 3ï¸âƒ£ Safety net: wait briefly if auth state is restoring
                status("Finalizing sign-inâ€¦");

                const user = await new Promise((resolve, reject) => {
                    const timeout = setTimeout(
                        () => reject(new Error("Auth timeout")),
                        8000
                    );

                    const unsub = onAuthStateChanged(auth, user => {
                        if (user) {
                            clearTimeout(timeout);
                            unsub();
                            resolve(user);
                        }
                    });
                });

                const token = await user.getIdToken();
                window.location.href =
                    `myapp://auth?token=${encodeURIComponent(token)}`;

            } catch (err) {
                status("Authentication error");
                log(err.message);
                console.error(err);
            }
        })();
    </script>
</body>

</html>